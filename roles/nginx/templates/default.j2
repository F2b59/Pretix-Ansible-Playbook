# {{ ansible_managed }}

# redirect all traffic to https
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    location / {
        return 301 https://$host$request_uri;
    }
}

# main server block
server {
    listen 443 ssl http2 default_server;
    listen [::]:443 ssl http2 default_server;

    server_name {{ domain_name }};

    include /etc/nginx/ssl.conf;

    location / {
        include /etc/nginx/proxy.conf;
        proxy_pass http://127.0.0.1:{{ pretix_port }};
    }

    {% if 'prometheus' in ansible_facts.packages %}

    location /prometheus {
        include /etc/nginx/proxy.conf;
        proxy_pass http://127.0.0.1:{{ prometheus_port }};

        {% if allow_prometheus_only_for_localhost %}

        allow 127.0.0.1;
        deny all;
        {% endif %}
    }
    {% endif %}

    {% if 'grafana' in ansible_facts.packages %}

    location /grafana {
        include /etc/nginx/proxy.conf;
        proxy_pass http://127.0.0.1:{{ grafana_port }};
    }
    {% endif %}

    # deny access to .htaccess/.htpasswd files
    location ~ /\.ht {
        deny all;
    }

}

server {
	listen 8080;
	server_name "";

	location /stub_status {
		stub_status;
		allow 127.0.0.1;
		deny all;
	}
}
